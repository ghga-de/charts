apiVersion: apps/v1
kind: Deployment
metadata:
  name: drs3
  labels:
    app: drs3
spec:
  replicas: {{ .Values.replicas }}
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app: drs3
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-init-first: "true"
        vault.hashicorp.com/tls-skip-verify: "true"
        vault.hashicorp.com/agent-inject-secret-variables: 'secret/data/files/drs3'
        vault.hashicorp.com/agent-inject-template-variables: |
          {{ with secret "secret/data/files/drs3" -}}
            export DCS_DB_URL="{{ .Data.data.db_url }}"
          export DCS_S3_ACCESS_KEY_ID="{{ .Data.data.s3_access }}"
          export DCS_S3_ENDPOINT_URL="{{ .Data.data.s3_url }}"
          export DCS_S3_OUTBOX_BUCKET_ID="{{ .Data.data.s3_outbox_bucket }}"
          export DCS_S3_SECRET_ACCESS_KEY="{{ .Data.data.s3_secret }}"
          export DCS_DRS_SELF_URL="{{ .Data.data.drs_self_url }}"
          export DCS_CUSTOM_SPEC_URL="{{ .Data.data.custom_spec_url }}"
          {{- end }}
        vault.hashicorp.com/role: "files-io-role"
      labels:
        app: drs3
        version: 1-dev
        logging-enabled: "true"
        sidecar.istio.io/inject: "true"
    spec:
      serviceAccountName: drs3
      containers:
      - name: drs3
        image: ghga/download-controller-service:0.4.0-19-gc61daa8-main
        command: ["bash"]
        args:  [ '-c', 'source /vault/secrets/variables && dcs']
        env:
          - name: DRS3_PORT
            value: {{ .Values.drs3Port }}
        securityContext:
          runAsUser: 1000
          capabilities:
            drop:
              - all
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          allowPrivilegeEscalation: false
        ports:
        - name: http
          containerPort: {{ .Values.drs3Port }}
          protocol: TCP
        resources:
          limits:
            cpu: {{ .Values.resources.limits.cpu }}
            memory: {{ .Values.resources.limits.memory }}
          requests:
            cpu: {{ .Values.resources.requests.cpu }}
            memory: {{ .Values.resources.requests.memory }}
        volumeMounts:
        - name: config
          mountPath: "/home/appuser"
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: drs3