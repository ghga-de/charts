apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: metadata-repository-service
  name: metadata-repository-service
spec:
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app: metadata-repository-service
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-init-first: "true"
        vault.hashicorp.com/tls-skip-verify: "true"
        vault.hashicorp.com/agent-pre-populate-only: "true"
        vault.hashicorp.com/agent-inject-secret-variables: 'secret/data/metadata-repository-service/data'
        vault.hashicorp.com/agent-inject-template-variables: |
          {{ with secret "secret/data/metadata-repository-service/data" -}}
          export METADATA_REPOSITORY_SERVICE_DB_URL={{ .Data.data.db_url }}
          {{- end }}
        vault.hashicorp.com/role: "metadata-repository-service-role"
        vault.hashicorp.com/agent-run-as-same-user: "true"
        proxy.istio.io/config: '{ "holdApplicationUntilProxyStarts": true }'
      labels:
        app: metadata-repository-service
        version: staging
        sidecar.istio.io/inject: "true"
    spec:
      serviceAccountName: metadata-repository-service
      containers:
        - args:
            - |2
              source /vault/secrets/variables
              shred /vault/secrets/*
              metadata-repository-service
          command:
            - bash
            - -c
          env:
            - name: METADATA_REPOSITORY_SERVICE_API_ROOT_PATH
              value: {{ .Values.apiRootPath }}
            - name: METADATA_REPOSITORY_SERVICE_CORS_ALLOWED_HEADERS
              value: {{ .Values.corsAllowedHeaders }}
            - name: METADATA_REPOSITORY_SERVICE_CORS_ALLOWED_METHODS
              value: {{ .Values.corsAllowedMethods }}
            - name: METADATA_REPOSITORY_SERVICE_CORS_ALLOWED_ORIGINS
              value: {{ .Values.corsAllowedOrigins }}
            - name: METADATA_REPOSITORY_SERVICE_CORS_ALLOW_CREDENTIALS
              value: {{ .Values.corsAllowedCredentials }}
            - name: METADATA_REPOSITORY_SERVICE_DB_NAME
              value: {{ .Values.dbName }}
            - name: METADATA_REPOSITORY_SERVICE_HOST
              value: {{ .Values.serviceHost }}
            - name: METADATA_REPOSITORY_SERVICE_PORT
              value: {{ .Values.servicePort }}
            - name: METADATA_REPOSITORY_SERVICE_LOG_LEVEL
              value: {{ .Values.logLevel }}
          image: ghga/metadata-repository-service:0.0.0-69-75b06e7-main
          name: metadata-repository-service
          securityContext:
            runAsUser: 1000
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            seccompProfile:
              type: "RuntimeDefault"
          ports:
           - containerPort: {{ .Values.servicePort }}
          resources:
            limits:
              cpu: {{ .Values.resources.limits.cpu }}
              memory: {{ .Values.resources.limits.memory }}
            requests:
              cpu: {{ .Values.resources.requests.cpu }}
              memory: {{ .Values.resources.requests.memory }}
          readinessProbe:
            tcpSocket:
              port: {{ .Values.servicePort }}
            initialDelaySeconds: 10
            periodSeconds: 15
          livenessProbe:
            tcpSocket:
              port: {{ .Values.servicePort }}
            initialDelaySeconds: 10
            periodSeconds: 15
